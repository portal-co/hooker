{"mappings":"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","sources":["packages/core/index.ts","packages/core/events.ts"],"sourcesContent":["import {\n  _WeakMap_prototype,\n  _WeakMap,\n  snapshot,\n  snapshotProto,\n} from \"@portal-solutions/hooker-snap\";\n\nexport const hookProxies: WeakMap<any, any> = _WeakMap\n  ? new _WeakMap()\n  : undefined;\nconst _hookProxies = hookProxies;\nexport const _Proxy: typeof Proxy = globalThis?.Proxy;\nexport const _Reflect: typeof Reflect =\n  \"Reflect\" in globalThis ? { ...Reflect } : (undefined as any);\nconst { isFrozen: _isFrozen } = Object;\nexport type HookPropOpts = {\n  Reflect?: typeof _Reflect;\n  attempt?: boolean;\n  isFrozen?: typeof _isFrozen;\n};\nexport type HookOpts = {\n  isProperty?: boolean;\n  Proxy?: typeof _Proxy;\n  hookProxies?: typeof hookProxies;\n} & HookPropOpts;\n\nexport function hook<T extends { [a in K]: object }, K extends keyof T>(\n  object: T,\n  key: K,\n  hook: (Reflect: typeof _Reflect) => ProxyHandler<T[K]>,\n  {\n    isProperty = false,\n    Proxy = _Proxy,\n    Reflect = _Reflect,\n    hookProxies = _hookProxies,\n    attempt = false,\n    isFrozen = _isFrozen,\n  }: HookOpts = {}\n) {\n  // a[b] = new _Proxy(a[b], c(_Reflect));\n  if (attempt && isFrozen(object)) return;\n  if (isProperty) {\n    hookProp(\n      object,\n      key,\n      (descriptor) => (\n        (descriptor ??= { value: undefined }),\n        {\n          configurable: descriptor?.configurable ?? true,\n          enumerable: descriptor?.enumerable ?? true,\n          writable: descriptor?.writable ?? true,\n          get() {\n            var proxy: T[K], value: T[K];\n            if (descriptor?.get) {\n              proxy = new Proxy((value = descriptor!.get!()), hook(Reflect));\n            } else {\n              proxy = new Proxy((value = descriptor!.value!), hook(Reflect));\n            }\n            _WeakMap_prototype.set(hookProxies, proxy, value);\n            return proxy;\n          },\n          set(value) {\n            while (_WeakMap_prototype.has(hookProxies, value)) {\n              value = _WeakMap_prototype.get(hookProxies, value)!;\n            }\n            if (descriptor?.set) {\n              descriptor!.set!(value);\n            } else {\n              descriptor.value = value;\n            }\n          },\n        }\n      ),\n      { Reflect, attempt, isFrozen }\n    );\n  } else {\n    object[key] = new Proxy(object[key], hook(Reflect));\n  }\n}\nexport function hookProp<T extends { [a in K]: any }, K extends keyof T>(\n  object: T,\n  key: K,\n  hook: (\n    descriptor: TypedPropertyDescriptor<T[K]> | undefined\n  ) => TypedPropertyDescriptor<T[K]>,\n  {\n    Reflect = _Reflect,\n    attempt = false,\n    isFrozen = _isFrozen,\n  }: HookPropOpts = {}\n) {\n  if (attempt && isFrozen(object)) return;\n  const descriptor = Reflect.getOwnPropertyDescriptor(object, key);\n  // if (d !== undefined) {\n  Reflect.defineProperty(object, key, hook(descriptor));\n  // }\n}\nexport * from \"./events.ts\";\nexport * from \"@portal-solutions/hooker-snap\";\n","import { _Proxy, _Reflect, _WeakMap_prototype, _WeakMap, hook, HookOpts } from \"./index.ts\";\n\nexport let events: WeakMap<Event, Event> = new _WeakMap();\nexport function hookEvent<T extends EventTarget>(ev: T, event_proxy: (Reflect: typeof _Reflect, name: string) => ProxyHandler<Event>,opts: HookOpts = {}) {\n    const handlerMap: WeakMap<any, any> = new _WeakMap();\n    hook(ev, \"addEventListener\", Reflect => ({\n        apply(target, thisArg, argArray) {\n            let handler = argArray[1];\n            let name;\n            let h2 = origEvent => {\n                const newEvent = new (opts.Proxy ?? _Proxy)(origEvent, event_proxy(Reflect, name));\n                _WeakMap_prototype.set(events, newEvent, origEvent);\n                handler(newEvent);\n            };\n            _WeakMap_prototype.set(handlerMap, handler, h2);\n            return Reflect.apply(target, thisArg, [name = argArray[0], h2]);\n        },\n    }),opts);\n    hook(ev, \"removeEventListener\", Reflect => ({\n        apply(target, thisArg, argArray) {\n            let handler = argArray[1];\n            let h2 = _WeakMap_prototype.get(handlerMap, handler);\n            _WeakMap_prototype.delete(handlerMap, handler);\n            return Reflect.apply(target, thisArg, [argArray[0], h2]);\n        },\n    }),opts);\n    if (ev instanceof EventSource) {\n        hook(ev, \"dispatchEvent\", Reflect => ({\n            apply(target, thisArg, argArray) {\n                var ev = argArray[0];\n                if (_WeakMap_prototype.has(events, ev)) {\n                    ev = _WeakMap_prototype.get(events, ev)!;\n                }\n                return Reflect.apply(target, thisArg, [ev])\n            },\n        }),opts);\n    }\n}"],"names":[],"version":3,"file":"index.js.map"}