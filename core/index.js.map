{"mappings":"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","sources":["core/index.ts","core/events.ts"],"sourcesContent":["import { _WeakMap_prototype, snapshot, snapshotProto } from '@portal-solutions/hooker-snap';\n\nexport const hookProxies: WeakMap<any, any> = new WeakMap();\nexport const _Proxy: typeof Proxy = globalThis?.Proxy;\nexport const _Reflect: typeof Reflect = 'Reflect' in globalThis ? { ...Reflect } : undefined as any;\nexport type HookOpts = { isProperty?: boolean, Proxy?: typeof _Proxy, Reflect?: typeof _Reflect };\nexport function hook<T extends { [a in K]: object }, K extends keyof T>(object: T, key: K, hook: (Reflect: typeof _Reflect) => ProxyHandler<T[K]>, { isProperty = false, Proxy = _Proxy, Reflect = _Reflect }: HookOpts = {}) {\n    // a[b] = new _Proxy(a[b], c(_Reflect));\n    if (isProperty) {\n        hookProp(object, key, descriptor => ((descriptor ??= { value: undefined }), {\n            configurable: descriptor?.configurable ?? true,\n            enumerable: descriptor?.enumerable ?? true,\n            writable: descriptor?.writable ?? true,\n            get() {\n                var proxy: T[K], value: T[K];\n                if (descriptor?.get) {\n                    proxy = new (Proxy)(value = descriptor!.get!(), hook(Reflect));\n                } else {\n                    proxy = new (Proxy)(value = descriptor!.value!, hook(Reflect));\n                }\n                _WeakMap_prototype.set(hookProxies, proxy, value);\n                return proxy;\n            },\n            set(value) {\n                while (_WeakMap_prototype.has(hookProxies, value)) {\n                    value = _WeakMap_prototype.get(hookProxies, value)!;\n                }\n                if (descriptor?.set) {\n                    descriptor!.set!(value)\n                } else {\n                    descriptor.value = value;\n                }\n            }\n        }), { Reflect });\n    } else {\n        object[key] = new (Proxy)(object[key], hook(Reflect));\n    }\n}\nexport function hookProp<T extends { [a in K]: any }, K extends keyof T>(object: T, key: K, hook: (descriptor: TypedPropertyDescriptor<T[K]> | undefined) => TypedPropertyDescriptor<T[K]>, { Reflect = _Reflect }: { Reflect?: typeof _Reflect } = {}) {\n    const descriptor = Reflect.getOwnPropertyDescriptor(object, key);\n    // if (d !== undefined) {\n    Reflect.defineProperty(object, key, hook(descriptor));\n    // }\n}\nexport * from './events.ts'\nexport * from '@portal-solutions/hooker-snap'","import { _Proxy, _Reflect, _WeakMap_prototype, _WeakMap, hook, HookOpts } from \"./index.ts\";\n\nexport let events: WeakMap<Event, Event> = new _WeakMap();\nexport function hookEvent<T extends EventTarget>(ev: T, event_proxy: (Reflect: typeof _Reflect, name: string) => ProxyHandler<Event>,opts: HookOpts = {}) {\n    const handlerMap: WeakMap<any, any> = new _WeakMap();\n    hook(ev, \"addEventListener\", Reflect => ({\n        apply(target, thisArg, argArray) {\n            let handler = argArray[1];\n            let name;\n            let h2 = origEvent => {\n                const newEvent = new (opts.Proxy ?? _Proxy)(origEvent, event_proxy(Reflect, name));\n                _WeakMap_prototype.set(events, newEvent, origEvent);\n                handler(newEvent);\n            };\n            _WeakMap_prototype.set(handlerMap, handler, h2);\n            return Reflect.apply(target, thisArg, [name = argArray[0], h2]);\n        },\n    }),opts);\n    hook(ev, \"removeEventListener\", Reflect => ({\n        apply(target, thisArg, argArray) {\n            let handler = argArray[1];\n            let h2 = _WeakMap_prototype.get(handlerMap, handler);\n            _WeakMap_prototype.delete(handlerMap, handler);\n            return Reflect.apply(target, thisArg, [argArray[0], h2]);\n        },\n    }),opts);\n    if (ev instanceof EventSource) {\n        hook(ev, \"dispatchEvent\", Reflect => ({\n            apply(target, thisArg, argArray) {\n                var ev = argArray[0];\n                if (_WeakMap_prototype.has(events, ev)) {\n                    ev = _WeakMap_prototype.get(events, ev)!;\n                }\n                return Reflect.apply(target, thisArg, [ev])\n            },\n        }),opts);\n    }\n}"],"names":[],"version":3,"file":"index.js.map"}