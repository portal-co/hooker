{"mappings":"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","sources":["core/index.ts","core/events.ts"],"sourcesContent":["import { _WeakMap_prototype, snapshot, snapshotProto } from '@portal-solutions/hooker-snap';\n\nexport const hookProxies: WeakMap<any, any> = new WeakMap();\nexport const _Proxy: typeof Proxy = globalThis?.Proxy;\nexport const _Reflect: typeof Reflect = 'Reflect' in globalThis ? { ...Reflect } : undefined as any;\nexport type HookOpts = { isProperty?: boolean, Proxy?: typeof _Proxy, Reflect?: typeof _Reflect };\nexport function hook<T extends { [a in K]: object }, K extends keyof T>(a: T, b: K, c: (Reflect: typeof _Reflect) => ProxyHandler<T[K]>, { isProperty = false, Proxy = _Proxy, Reflect = _Reflect }: HookOpts = {}) {\n    // a[b] = new _Proxy(a[b], c(_Reflect));\n    if (isProperty) {\n        hookProp(a, b, d => ((d ??= { value: undefined }), {\n            configurable: d?.configurable ?? true,\n            enumerable: d?.enumerable ?? true,\n            writable: d?.writable ?? true,\n            get() {\n                var p: T[K], v: T[K];\n                if (d?.get) {\n                    p = new (Proxy)(v = d!.get!(), c(Reflect));\n                } else {\n                    p = new (Proxy)(v = d!.value!, c(Reflect));\n                }\n                _WeakMap_prototype.set(hookProxies, p, v);\n                return p;\n            },\n            set(value) {\n                while (_WeakMap_prototype.has(hookProxies, value)) {\n                    value = _WeakMap_prototype.get(hookProxies, value)!;\n                }\n                if (d?.set) {\n                    d!.set!(value)\n                } else {\n                    d.value = value;\n                }\n            }\n        }), { Reflect });\n    } else {\n        a[b] = new (Proxy)(a[b], c(Reflect));\n    }\n}\nexport function hookProp<T extends { [a in K]: any }, K extends keyof T>(a: T, b: K, c: (d: TypedPropertyDescriptor<T[K]> | undefined) => TypedPropertyDescriptor<T[K]>, { Reflect = _Reflect }: { Reflect?: typeof _Reflect } = {}) {\n    let d = Reflect.getOwnPropertyDescriptor(a, b);\n    // if (d !== undefined) {\n    Reflect.defineProperty(a, b, c(d));\n    // }\n}\nexport * from './events.ts'\nexport * from '@portal-solutions/hooker-snap'","import { _Proxy, _Reflect, _WeakMap_prototype, _WeakMap, hook, HookOpts } from \"./index.ts\";\n\nexport let events: WeakMap<Event, Event> = new _WeakMap();\nexport function hookEvent<T extends EventTarget>(ev: T, event_proxy: (Reflect: typeof _Reflect, name: string) => ProxyHandler<Event>,opts: HookOpts = {}) {\n    let m: WeakMap<any, any> = new _WeakMap();\n    hook(ev, \"addEventListener\", Reflect => ({\n        apply(target, thisArg, argArray) {\n            let handler = argArray[1];\n            let name;\n            let h2 = $ => {\n                let e = new (opts.Proxy ?? _Proxy)($, event_proxy(Reflect, name));\n                _WeakMap_prototype.set(events, e, $);\n                handler(e);\n            };\n            _WeakMap_prototype.set(m, handler, h2);\n            return Reflect.apply(target, thisArg, [name = argArray[0], h2]);\n        },\n    }),opts);\n    hook(ev, \"removeEventListener\", Reflect => ({\n        apply(target, thisArg, argArray) {\n            let handler = argArray[1];\n            let h2 = _WeakMap_prototype.get(m, handler);\n            _WeakMap_prototype.delete(m, handler);\n            return Reflect.apply(target, thisArg, [argArray[0], h2]);\n        },\n    }),opts);\n    if (ev instanceof EventSource) {\n        hook(ev, \"dispatchEvent\", Reflect => ({\n            apply(target, thisArg, argArray) {\n                var ev = argArray[0];\n                if (_WeakMap_prototype.has(events, ev)) {\n                    ev = _WeakMap_prototype.get(events, ev)!;\n                }\n                return Reflect.apply(target, thisArg, [ev])\n            },\n        }),opts);\n    }\n}"],"names":[],"version":3,"file":"index.js.map"}