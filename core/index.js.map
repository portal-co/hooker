{"mappings":"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","sources":["core/index.ts","core/extras.ts","core/events.ts"],"sourcesContent":["import { _WeakMap_prototype } from './extras.ts';\n\nexport const _Proxy = Proxy;\nexport const _Reflect: typeof Reflect = { ...Reflect };\nexport const hookProxies: WeakMap<any, any> = new WeakMap();\nexport function snapshot<T, U, V>(fn: (this: T, ...U) => V): (self: T, ...U) => V {\n    return fn.call.bind(fn);\n}\nexport type SnapshotInput<T, U, V> = (this: T, ...U) => V;\nexport type ProtoSnapshot<T> = { [Prop in keyof T]: T[Prop] extends SnapshotInput<infer T2, infer U, infer V> ? (self: T2, ...U) => V : never };\nexport function snapshotProto<T extends object>(val: T): ProtoSnapshot<T> {\n    let a = {};\n    for (let k of Object.keys(val)) {\n        let wrapped;\n        if ((wrapped = val[k]) instanceof Function) a[k] = snapshot(wrapped);\n    }\n    return a as ProtoSnapshot<T>;\n}\n\nexport function hook<T extends { [a in K]: object }, K extends keyof T>(a: T, b: K, c: (Reflect: typeof _Reflect) => ProxyHandler<T[K]>, { isProperty = false, Proxy = _Proxy }: { isProperty?: boolean, Proxy?: typeof _Proxy } = {}) {\n    // a[b] = new _Proxy(a[b], c(_Reflect));\n    if (isProperty) {\n        hookProp(a, b, d => ((d ??= { value: undefined }), {\n            configurable: d?.configurable ?? true,\n            enumerable: d?.enumerable ?? true,\n            writable: d?.writable ?? true,\n            get() {\n                var p: T[K], v: T[K];\n                if (d?.get) {\n                    p = new (Proxy)(v = d!.get!(), c(_Reflect));\n                } else {\n                    p = new (Proxy)(v = d!.value!, c(_Reflect));\n                }\n                _WeakMap_prototype.set(hookProxies, p, v);\n                return p;\n            },\n            set(value) {\n                while (_WeakMap_prototype.has(hookProxies, value)) {\n                    value = _WeakMap_prototype.get(hookProxies, value)!;\n                }\n                if (d?.set) {\n                    d!.set!(value)\n                } else {\n                    d.value = value;\n                }\n            }\n        }));\n    } else {\n        a[b] = new (Proxy)(a[b],c(_Reflect));\n    }\n}\nexport function hookProp<T extends { [a in K]: any }, K extends keyof T>(a: T, b: K, c: (d: TypedPropertyDescriptor<T[K]> | undefined) => TypedPropertyDescriptor<T[K]>) {\n    let d = _Reflect.getOwnPropertyDescriptor(a, b);\n    // if (d !== undefined) {\n    _Reflect.defineProperty(a, b, c(d));\n    // }\n}\nexport * from './events.ts'\nexport * from './extras.ts'","\nimport { snapshotProto } from \"./index.ts\";\n\nexport const _DataView = DataView;\nexport const _DataView_prototype = snapshotProto(_DataView.prototype) \n\n\nexport const _ArrayBuffer = ArrayBuffer;\n\n\n\nexport const _Uint8Array = Uint8Array;\nexport const _Uint8Array_prototype = snapshotProto(_Uint8Array.prototype) \n\n\nexport const _WeakMap = WeakMap;\nexport const _WeakMap_prototype = snapshotProto(_WeakMap.prototype) \n\n","import { _Proxy, _Reflect, _WeakMap_prototype, hook } from \"./index.ts\";\n\nexport let events: WeakMap<Event, Event> = new WeakMap();\nexport function hookEvent<T extends EventTarget>(ev: T, event_proxy: (Reflect: typeof _Reflect, name: string) => ProxyHandler<Event>) {\n    let m: WeakMap<any, any> = new WeakMap();\n    hook(ev, \"addEventListener\", Reflect => ({\n        apply(target, thisArg, argArray) {\n            let handler = argArray[1];\n            let name;\n            let h2 = $ => {\n                let e = new _Proxy($, event_proxy(Reflect, name));\n                _WeakMap_prototype.set(events, e, $);\n                handler(e);\n            };\n            m.set(handler, h2);\n            return Reflect.apply(target, thisArg, [name = argArray[0], h2]);\n        },\n    }));\n    hook(ev, \"removeEventListener\", Reflect => ({\n        apply(target, thisArg, argArray) {\n            let handler = argArray[1];\n            let h2 = _WeakMap_prototype.get(m, handler);\n            _WeakMap_prototype.delete(m, handler);\n            return Reflect.apply(target, thisArg, [argArray[0], h2]);\n        },\n    }));\n    if (ev instanceof EventSource) {\n        hook(ev, \"dispatchEvent\", Reflect => ({\n            apply(target, thisArg, argArray) {\n                var ev = argArray[0];\n                if (_WeakMap_prototype.has(events, ev)) {\n                    ev = _WeakMap_prototype.get(events, ev)!;\n                }\n                return Reflect.apply(target, thisArg, [ev])\n            },\n        }));\n    }\n}"],"names":[],"version":3,"file":"index.js.map"}